# Cursor Rules for FBX Optimizer Project

## ğŸ“‹ å°ˆæ¡ˆæ¦‚è¿°
**JR 3D Viewer / FBX Optimizer** - Web-based 3D æ¨¡å‹æª¢è¦–èˆ‡å„ªåŒ–å·¥å…·
- **æŠ€è¡“æ£§**ï¼šReact 19 + TypeScript + Three.js + Vite
- **æ¶æ§‹**ï¼šDDD åˆ†å±¤æ¶æ§‹ï¼ˆDomain â†’ Application â†’ Infrastructure â†’ Presentationï¼‰

---

## ğŸ—ï¸ å°ˆæ¡ˆçµæ§‹é€ŸæŸ¥

```
src/
â”œâ”€â”€ domain/                    # ç´”æ¥­å‹™é‚è¼¯ï¼ˆç„¡å¤–éƒ¨ä¾è³´ï¼‰
â”‚   â”œâ”€â”€ services/              # AnimationOptimizer, ModelLoaderService...
â”‚   â””â”€â”€ value-objects/         # ModelInstance, ShaderFeature, AudioTrack, Layer, SpineInstance...
â”œâ”€â”€ application/use-cases/     # Use Casesï¼ˆéœæ…‹ execute() æ–¹æ³•ï¼‰
â”œâ”€â”€ infrastructure/            # å¤–éƒ¨ API å°è£
â”‚   â”œâ”€â”€ audio/                 # WebAudioAdapter, AudioGraphBuilder
â”‚   â”œâ”€â”€ effect/                # EffekseerRuntimeAdapter
â”‚   â””â”€â”€ spine/                 # SpineRuntimeAdapter, SpineCanvasRenderer
â”œâ”€â”€ presentation/              # React UI
â”‚   â”œâ”€â”€ features/              # åŠŸèƒ½æ¨¡çµ„ï¼ˆscene-viewer, audio-panel, director, spine-panel...ï¼‰
â”‚   â”œâ”€â”€ hooks/                 # å…±ç”¨ Hooks
â”‚   â”œâ”€â”€ components/            # å…±ç”¨çµ„ä»¶ï¼ˆProgressBarï¼‰
â”‚   â””â”€â”€ stores/                # ç‹€æ…‹ç®¡ç†ï¼ˆdirectorStore, spineStoreï¼‰
â”œâ”€â”€ utils/                     # å·¥å…·å‡½æ•¸ï¼ˆarray/, clip/, shader/...ï¼‰
â”œâ”€â”€ vendor/                    # ç¬¬ä¸‰æ–¹åº«ï¼ˆspine-ts-3.8/ï¼‰
â””â”€â”€ types/                     # é¡å‹å®šç¾©ï¼ˆeffekseer.d.ts, shaderTypes.tsï¼‰
```

---

## âš ï¸ åˆ†å±¤ä¾è³´è¦å‰‡ï¼ˆå¿…éµå®ˆï¼‰

| å±¤ç´š | å¯ä¾è³´ | ç¦æ­¢ä¾è³´ |
|------|--------|----------|
| **Domain** | TypeScript æ¨™æº–åº«ã€Three.js é¡å‹ | Reactã€Applicationã€Infrastructureã€Presentation |
| **Application** | Domainã€Infrastructure | Presentation |
| **Infrastructure** | Domain | Applicationã€Presentation |
| **Presentation** | Applicationã€Domain | Infrastructureï¼ˆé ˆé€é Use Casesï¼‰ |

---

## ğŸ“ å‘½åè¦ç¯„

### æª”æ¡ˆå‘½å
| é¡å‹ | æ ¼å¼ | ç¯„ä¾‹ |
|------|------|------|
| React çµ„ä»¶ | `PascalCase.tsx` | `SceneViewer.tsx` |
| Use Case | `PascalCaseUseCase.ts` | `LoadModelUseCase.ts` |
| Service | `PascalCaseService.ts` | `ModelLoaderService.ts` |
| Hook | `useCamelCase.ts` | `useTheme.ts` |
| å·¥å…·å‡½æ•¸ | `camelCaseUtils.ts` | `arrayUtils.ts` |
| Value Object | `PascalCase.ts` | `AudioTrack.ts` |

### è®Šæ•¸/å‡½æ•¸å‘½å
- **è®Šæ•¸**ï¼š`camelCase`ï¼ˆ`currentTime`, `audioTracks`ï¼‰
- **å¸¸æ•¸**ï¼š`UPPER_CASE`ï¼ˆ`SAMPLE_RATE`ï¼‰
- **é¡åˆ¥/ä»‹é¢**ï¼š`PascalCase`ï¼ˆ`AnimationOptimizer`, `ShaderGroup`ï¼‰
- **å‡½æ•¸**ï¼šå‹•è©é–‹é ­ï¼ˆ`loadModel()`, `createClip()`, `handleTimeUpdate()`ï¼‰
- **Hook**ï¼š`use` å‰ç¶´ï¼ˆ`useTheme()`, `useFileDrop()`ï¼‰

---

## ğŸ”§ ç¨‹å¼ç¢¼é¢¨æ ¼

### TypeScript
```typescript
// âœ… ä½¿ç”¨ interface å®šç¾©ç‰©ä»¶çµæ§‹
interface LoadModelParams {
  files: File[];
  onProgress?: (percent: number) => void;
}

// âœ… Use Case éœæ…‹ execute æ–¹æ³•
class LoadModelUseCase {
  static async execute(params: LoadModelParams): Promise<LoadModelResult> { }
}

// âœ… æ˜ç¢ºé¡å‹ï¼Œé¿å… any
const tracks: AudioTrack[] = [];
```

### React
```typescript
// âœ… å‡½æ•¸çµ„ä»¶ + TypeScript Props
interface SceneViewerProps {
  model: THREE.Group | null;
  onTimeUpdate: (time: number) => void;
}

export const SceneViewer = forwardRef<SceneViewerRef, SceneViewerProps>(
  ({ model, onTimeUpdate }, ref) => { }
);

// âœ… ä½¿ç”¨ useCallback/useMemo å„ªåŒ–ï¼ˆç•¶ä½œç‚º props å‚³éæ™‚ï¼‰
const handlePlay = useCallback(() => { }, [deps]);
```

### å‡½æ•¸å¼æ›´æ–°
```typescript
// âœ… ä¸å¯è®Šæ›´æ–°
setTracks(prev => prev.map(t => t.id === id ? { ...t, volume } : t));

// âœ… ä½¿ç”¨å·¥å…·å‡½æ•¸
import { updateArrayItemById } from './utils/array/arrayUtils';
setTracks(prev => updateArrayItemById(prev, id, { volume }));
```

---

## ğŸ¯ æ ¸å¿ƒé¡å‹é€ŸæŸ¥

### ModelInstanceï¼ˆæ¨¡å‹å¯¦ä¾‹ï¼‰
```typescript
interface ModelInstance {
  id: string;
  model: THREE.Group | null;
  meshNames: string[];
  originalClip: IdentifiableClip | null;
  createdClips: IdentifiableClip[];
  shaderGroups: ShaderGroup[];
  audioTracks: AudioTrack[];
  effects: EffectItem[];
}
```

### Layerï¼ˆ2D åœ–å±¤ï¼‰
```typescript
interface Layer {
  id: string;
  type: '3d' | '2d';
  priority: number;  // >0: å‰æ™¯, =0: 3D, <0: èƒŒæ™¯
  children: Element2D[];
}
```

### IdentifiableClipï¼ˆå¯è­˜åˆ¥å‹•ç•«ç‰‡æ®µï¼‰
```typescript
interface IdentifiableClip extends THREE.AnimationClip {
  customId: string;      // å”¯ä¸€ ID
  displayName: string;   // é¡¯ç¤ºåç¨±
}
```

### DirectorClipï¼ˆDirector Mode ç‰‡æ®µï¼‰
```typescript
interface DirectorClip {
  id: string;
  trackId: string;
  sourceModelId: string;        // ä¾†æºæ¨¡å‹ ID
  sourceModelName: string;      // ä¾†æºæ¨¡å‹åç¨±
  sourceAnimationId: string;    // å‹•ç•« ID
  sourceAnimationName: string;  // å‹•ç•«åç¨±
  startFrame: number;           // èµ·å§‹å¹€
  durationFrames: number;       // æŒçºŒå¹€æ•¸
}
```

### DirectorTrackï¼ˆDirector Mode è»Œé“ï¼‰
```typescript
interface DirectorTrack {
  id: string;
  name: string;
  order: number;
  isMuted: boolean;
  isLocked: boolean;
  clips: DirectorClip[];
}
```

### SpineElement2Dï¼ˆSpine å‹•ç•«å…ƒç´ ï¼‰
```typescript
interface SpineElement2D extends Element2DBase {
  type: 'spine';
  spineInstanceId: string;    // SpineRuntimeAdapter ä¸­çš„å¯¦ä¾‹ ID
  currentAnimation: string | null;
  currentSkin: string | null;
  loop: boolean;
  timeScale: number;
  isPlaying: boolean;
  currentTime: number;
  scale: number;
  flipX: boolean;
  flipY: boolean;
}
```

---

## ğŸš« ç¦æ­¢äº‹é …

1. âŒ Domain å±¤ä½¿ç”¨ React Hooks æˆ– Three.js ç‰©ä»¶å¯¦ä¾‹
2. âŒ Presentation å±¤ç›´æ¥å‘¼å« Infrastructure
3. âŒ ä½¿ç”¨ `any` é¡å‹ï¼ˆç”¨ `unknown` æˆ–å…·é«”é¡å‹ï¼‰
4. âŒ ç›´æ¥ä¿®æ”¹ props æˆ–ç‹€æ…‹
5. âŒ åœ¨çµ„ä»¶ä¸­å¯«è¤‡é›œæ¥­å‹™é‚è¼¯ï¼ˆç§»è‡³ Use Casesï¼‰
6. âŒ æ¨¡ç³Šè®Šæ•¸åï¼ˆ`data`, `temp`, `obj`ï¼‰
7. âŒ åœ¨ `src/components/` æ ¹ç›®éŒ„å»ºæ–°æª”æ¡ˆ

---

## âœ… æœ€ä½³å¯¦è¸

1. **æ–°å¢åŠŸèƒ½**ï¼šåœ¨ `presentation/features/[name]/` å‰µå»ºæ¨¡çµ„
2. **æ¥­å‹™é‚è¼¯**ï¼šå°è£åœ¨ Use Casesï¼ˆ`application/use-cases/`ï¼‰
3. **è³‡æ–™çµæ§‹**ï¼šå®šç¾©ç‚º Value Objectï¼ˆ`domain/value-objects/`ï¼‰
4. **å¤–éƒ¨ API**ï¼šå°è£åœ¨ Infrastructureï¼ˆ`infrastructure/`ï¼‰
5. **å…±ç”¨é‚è¼¯**ï¼šæå–ç‚º Hookï¼ˆ`presentation/hooks/`ï¼‰
6. **å·¥å…·å‡½æ•¸**ï¼šæ”¾åœ¨ `utils/[category]/`
7. **å…¨åŸŸç‹€æ…‹**ï¼šDirector Mode ä½¿ç”¨ Zustandï¼ˆ`presentation/stores/directorStore.ts`ï¼‰

---

## ğŸ¬ Director Mode é€ŸæŸ¥

### æ ¸å¿ƒæ¦‚å¿µ
- **Trackï¼ˆè»Œé“ï¼‰**ï¼šæ©«å‘è»Œé“ï¼Œå¯æ”¾ç½®å¤šå€‹ Clip
- **Clipï¼ˆç‰‡æ®µï¼‰**ï¼šä¸€å€‹å‹•ç•«åœ¨è»Œé“ä¸Šçš„å¯¦ä¾‹
- **Timelineï¼ˆæ™‚é–“è»¸ï¼‰**ï¼šå…¨åŸŸæ™‚é–“è»¸ï¼ˆä»¥å¹€ç‚ºå–®ä½ï¼‰
- **Playheadï¼ˆæ’­æ”¾é ­ï¼‰**ï¼šç•¶å‰æ’­æ”¾ä½ç½®

### é—œéµåŠŸèƒ½
- å¤šæ¨¡å‹å‹•ç•«çµ±ä¸€ç·¨æ’ï¼ˆé¡ä¼¼ Premiere Proï¼‰
- æ‹–æ”¾å‹•ä½œåˆ°æ™‚é–“è»¸
- å…¨åŸŸæ™‚é–“è»¸æ’­æ”¾æ§åˆ¶
- éŸ³æ•ˆèˆ‡ç‰¹æ•ˆè‡ªå‹•åŒæ­¥è§¸ç™¼
- é€²å…¥æ™‚è‡ªå‹•ç¦ç”¨æ¨¡å‹ LOOPï¼Œé€€å‡ºæ™‚æ¢å¾©

### ç‹€æ…‹ç®¡ç†
- ä½¿ç”¨ `directorStore`ï¼ˆZustandï¼‰ç®¡ç†å…¨åŸŸç‹€æ…‹
- ä¸»è¦ Actionsï¼š`addClip`, `moveClip`, `removeClip`, `play`, `pause`, `setCurrentFrame`

### æ™‚é–“è¨ˆç®—
```typescript
// å…¨åŸŸå¹€ â†’ ç‰‡æ®µå±€éƒ¨æ™‚é–“
localTime = (globalFrame - clip.startFrame) / fps
```

---

## ğŸ‡ Effekseer ç‰¹æ•ˆç³»çµ±é€ŸæŸ¥

### æ ¸å¿ƒçµ„ä»¶
- **EffekseerRuntimeAdapter**ï¼šå°è£ Effekseer WebGL Runtime
- **EffectTestPanel**ï¼šç‰¹æ•ˆæ¸¬è©¦é¢æ¿ï¼ˆå«è³‡æºç®¡ç†ï¼‰
- **effectResourceCache**ï¼šå…¨åŸŸè³‡æºå¿«å– Mapï¼ˆè§£æ±ºå…§éƒ¨å¿«å–å•é¡Œï¼‰

### è³‡æºè¿½è¹¤æ©Ÿåˆ¶
```typescript
// redirect å›èª¿æ””æˆªè³‡æºè«‹æ±‚
loadEffect(url, {
  redirect: (path) => {
    // è¨˜éŒ„è³‡æºè·¯å¾‘å’Œé¡å‹
    resourceStatusMap.set(path, { path, exists, type });
    return fullUrl;
  }
});

// å­˜å…¥å…¨åŸŸå¿«å–
effectResourceCache.set(localPath, resourceStatusArray);
```

### âš ï¸ Effekseer å¿«å–æ³¨æ„äº‹é …

1. **Effekseer å…§éƒ¨å¿«å–æ˜¯å…¨åŸŸå…±ç”¨çš„**
   - é‡è¤‡è¼‰å…¥æ™‚ `redirect` ä¸è¢«å‘¼å«
   - ä½¿ç”¨ `effectResourceCache` è§£æ±º

2. **æ¸…é™¤å¿«å–å½±éŸ¿æ‰€æœ‰æ¨¡å‹**
   ```typescript
   // éœ€è¦æ¸…é™¤æ‰€æœ‰æ¨¡å‹çš„ç‰¹æ•ˆç‹€æ…‹
   onClearAllModelsEffects={() => {
     models.forEach(m => updateModel(m.id, { effects: resetEffects }));
   }}
   ```

3. **æ‰“åŒ…åŒ¯å‡ºå¿…é ˆä½¿ç”¨ effectResourceCache**
   - ä¸èƒ½ä½¿ç”¨ `item.resourceStatus`ï¼ˆå¯èƒ½é¡¯ç¤ºã€Œå·²å¿«å–ã€ï¼‰

### è©³ç´°æ–‡æª”
- `archi_docs/EFFEKSEER_INTEGRATION_ARCHITECTURE.md`

---

## ğŸ¦´ Spine å‹•ç•«ç³»çµ±é€ŸæŸ¥

### æ ¸å¿ƒçµ„ä»¶
- **SpineRuntimeAdapter**ï¼šå–®ä¾‹æ¨¡å¼å°è£ Spine Runtime 3.8
- **SpineCanvasRenderer**ï¼šCanvas 2D æ¸²æŸ“å™¨
- **SpineElement**ï¼š2D åœ–å±¤ä¸­çš„éª¨æ¶å‹•ç•« React çµ„ä»¶
- **spineStore**ï¼šZustand ç‹€æ…‹ç®¡ç†

### å‹•ç•«æ›´æ–°æ©Ÿåˆ¶
```typescript
// SpineElement çš„å‹•ç•«å¾ªç’°ï¼ˆrequestAnimationFrameï¼‰
if (isLoaded && element.isPlaying) {
  adapter.update(spineInstanceId, deltaTime);  // æ¨é€²å‹•ç•«
  renderer.render(spineInstanceId, options);    // æ¸²æŸ“éª¨æ¶
  onUpdate?.({ currentTime });                  // åŒæ­¥æ™‚é–“å›çˆ¶çµ„ä»¶
}
```

### Director Mode æ•´åˆé‡é»
- `useDirectorSpineTrigger`ï¼šè¨‚é–± directorStore æ§åˆ¶ Spine æ’­æ”¾
- èª¿ç”¨ `adapter.resume()`ã€`adapter.pause()`ã€`adapter.seek()` æ§åˆ¶ç‹€æ…‹
- é€é `onUpdateSpineElement()` æ›´æ–° layers state

### âš ï¸ Director Mode ä¸‹ Spine æ³¨æ„äº‹é …

**å•é¡Œ**ï¼šåˆ‡æ›å³å´é¢æ¿åˆ°é 2D æ¨¡çµ„æ™‚ï¼ŒSpine å‹•ç•«å¯èƒ½å¡ä½

**åŸå› **ï¼š
1. `SpineElement` ä¾è³´ `onUpdate` å›èª¿åŒæ­¥ `currentTime`
2. é 2D æ¨¡çµ„æ™‚ `onUpdateElement` å¯èƒ½ç‚º `undefined`
3. æ™‚é–“ç„¡æ³•åŒæ­¥ â†’ seek useEffect è¢«éŒ¯èª¤è§¸ç™¼ â†’ å‹•ç•«ã€Œå€’é€€ã€

**è§£æ±ºæ–¹æ¡ˆ**ï¼šç¢ºä¿ Director æ¨¡å¼ä¸‹ `onUpdateElement` å§‹çµ‚å¯ç”¨
```typescript
// App.tsx ä¸­çš„ä¿®å¾©
onUpdateElement={(isPointerEditing || isDirectorMode) ? handleUpdateElementById : undefined}
```

---

æ¶æ§‹å‹çš„æ–‡ä»¶æª”æ¡ˆ æ”¾åœ¨ archi_docs/ ç›®éŒ„ä¸‹ 
è‡¨æ™‚æ–‡ä»¶æª”æ¡ˆ æ”¾åœ¨ temp_docs/ ç›®éŒ„ä¸‹ 

## ğŸ“– åƒè€ƒæ–‡æª”

- **æ¶æ§‹è©³è§£**ï¼š`PROJECT_ARCHITECTURE.md`
- **æŠ€è¡“ä¸Šä¸‹æ–‡**ï¼š`PROJECT_CONTEXT.md`
- **Director Mode è¨­è¨ˆ**ï¼š`archi_docs/DIRECTOR_MODE_DESIGN.md`
- **Spine æ•´åˆæ¶æ§‹**ï¼š`archi_docs/SPINE_INTEGRATION_ARCHITECTURE.md`
- **Effekseer æ•´åˆæ¶æ§‹**ï¼š`archi_docs/EFFEKSEER_INTEGRATION_ARCHITECTURE.md`

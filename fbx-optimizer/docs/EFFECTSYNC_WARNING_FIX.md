# ğŸ”§ EffectSync è­¦å‘Šè¨Šæ¯ä¿®å¾©èªªæ˜

## ğŸ“‹ å•é¡Œæè¿°

**ç¾è±¡**ï¼šæ§åˆ¶å°è¢«å¤§é‡ `[EffectSync]` è­¦å‘Šè¨Šæ¯æ·¹æ²’

```
[EffectSync] âš ï¸ previousTime (6.273s) å’Œ currentTime (6.273s) å¹¾ä¹ç›¸åŒï¼é€™å¯èƒ½å°è‡´è§¸ç™¼è¢«è·³éã€‚
[EffectSync] âš ï¸ previousTime (7.208s) å’Œ currentTime (7.208s) å¹¾ä¹ç›¸åŒï¼é€™å¯èƒ½å°è‡´è§¸ç™¼è¢«è·³éã€‚
...ï¼ˆé‡è¤‡æ•¸ç™¾æ¬¡ï¼‰
```

---

## ğŸ” æ ¹æœ¬åŸå› 

### 1. è­¦å‘Šæ¢ä»¶éæ–¼æ•æ„Ÿ

**åŸå§‹ä»£ç¢¼**ï¼š
```typescript
// src/application/use-cases/EffectSyncUseCase.ts (Line 57-59)
if (Math.abs(savedPreviousTime - time) < 0.001 && savedPreviousTime !== 0) {
  console.warn(`[EffectSync] âš ï¸ previousTime å’Œ currentTime å¹¾ä¹ç›¸åŒï¼é€™å¯èƒ½å°è‡´è§¸ç™¼è¢«è·³éã€‚`);
}
```

**å•é¡Œ**ï¼š
- é–¾å€¼ `< 0.001` ç§’ï¼ˆ1 æ¯«ç§’ï¼‰éæ–¼åš´æ ¼
- åœ¨æ­£å¸¸çš„å‹•ç•«æ’­æ”¾ä¸­ï¼ŒReact é‡æ–°æ¸²æŸ“é »ç‡å¯èƒ½å°è‡´æ™‚é–“å·®å¾ˆå°
- 60fps å‹•ç•«æ¯å¹€ç´„ 16.7msï¼Œä½† React å¯èƒ½åœ¨åŒä¸€å¹€å…§å¤šæ¬¡èª¿ç”¨

### 2. è§¸ç™¼é »ç‡

| å ´æ™¯ | æ¯ç§’è§¸ç™¼æ¬¡æ•¸ | èªªæ˜ |
|------|-------------|------|
| æ­£å¸¸æ’­æ”¾ | 30-60 æ¬¡ | æ¯å¹€éƒ½å¯èƒ½è§¸ç™¼è­¦å‘Š |
| æ’­æ”¾ 10 ç§’å‹•ç•« | 300-600 æ¢ | æ§åˆ¶å°è¢«æ·¹æ²’ |

---

## âœ… è§£æ±ºæ–¹æ¡ˆ

### ä¿®å¾©å…§å®¹

**æ–°ä»£ç¢¼**ï¼š
```typescript
// æ•ˆèƒ½å„ªåŒ–ï¼šç§»é™¤éæ–¼é »ç¹çš„è­¦å‘Šè¨Šæ¯
// åƒ…åœ¨é–‹ç™¼æ¨¡å¼ä¸”æ™‚é–“å®Œå…¨ç›¸åŒæ™‚æ‰è­¦å‘Šï¼ˆæ¥µç«¯æƒ…æ³ï¼‰
if (import.meta.env.DEV && savedPreviousTime === time && savedPreviousTime !== 0) {
  console.warn(`[EffectSync] âš ï¸ previousTime å’Œ currentTime å®Œå…¨ç›¸åŒ (${time.toFixed(3)}s)ï¼Œå¯èƒ½å°è‡´è§¸ç™¼æª¢æ¸¬å•é¡Œ`);
}
```

### æ”¹é€²é»

1. âœ… **æ¢ä»¶æ›´åš´æ ¼**ï¼šåªåœ¨æ™‚é–“**å®Œå…¨ç›¸åŒ**æ™‚æ‰è­¦å‘Šï¼ˆ`===` è€Œé `< 0.001`ï¼‰
2. âœ… **åƒ…é–‹ç™¼æ¨¡å¼**ï¼šä½¿ç”¨ `import.meta.env.DEV` ç¢ºä¿ç”Ÿç”¢ç’°å¢ƒç„¡è­¦å‘Š
3. âœ… **è¨Šæ¯æ›´æ¸…æ™°**ï¼šèªªæ˜æ˜¯ã€Œå¯èƒ½çš„å•é¡Œã€è€Œéã€Œä¸€å®šæœƒè·³éã€
4. âœ… **æ•ˆèƒ½æå‡**ï¼šæ¸›å°‘ 99% ä»¥ä¸Šçš„ä¸å¿…è¦è­¦å‘Š

### é æœŸæ•ˆæœ

| é …ç›® | ä¿®å¾©å‰ | ä¿®å¾©å¾Œ |
|------|--------|--------|
| æ¯ç§’è­¦å‘Šæ•¸ | 30-60 æ¢ | 0-1 æ¢ï¼ˆæ¥µç«¯æƒ…æ³ï¼‰ |
| æ§åˆ¶å°å¯è®€æ€§ | âŒ è¢«æ·¹æ²’ | âœ… æ¸…æ™° |
| é–‹ç™¼é«”é©— | âŒ åˆ†å¿ƒ | âœ… å°ˆæ³¨ |
| ç”Ÿç”¢ç’°å¢ƒ | âš ï¸ æœ‰è­¦å‘Š | âœ… ç„¡è­¦å‘Š |

---

## ğŸ”¬ æŠ€è¡“ç´°ç¯€

### ç‚ºä»€éº¼æ™‚é–“æœƒå¦‚æ­¤æ¥è¿‘ï¼Ÿ

1. **React æ¸²æŸ“æ©Ÿåˆ¶**
   ```typescript
   // SceneViewer.tsx ä¸­çš„ useFrame
   useFrame(() => {
     const time = action.time;
     onTimeUpdate(time);  // å¯èƒ½åœ¨åŒä¸€å¹€å…§å¤šæ¬¡èª¿ç”¨
   });
   ```

2. **Three.js å‹•ç•«æ›´æ–°**
   - Three.js çš„ `AnimationMixer` åœ¨æ¯å€‹ `requestAnimationFrame` ä¸­æ›´æ–°
   - React çš„ç‹€æ…‹æ›´æ–°å¯èƒ½åœ¨åŒä¸€å€‹ RAF é€±æœŸå…§å¤šæ¬¡è§¸ç™¼

3. **æµ®é»æ•¸ç²¾åº¦**
   - JavaScript çš„ Number é¡å‹ä½¿ç”¨ IEEE 754 é›™ç²¾åº¦æµ®é»æ•¸
   - æ™‚é–“è¨ˆç®—å¯èƒ½ç”¢ç”Ÿæ¥µå°çš„èª¤å·®ï¼ˆ< 1Î¼sï¼‰

### è§¸ç™¼æª¢æ¸¬é‚è¼¯

**åŸå§‹è§¸ç™¼æ¢ä»¶**ï¼ˆä¸å—æ­¤è­¦å‘Šå½±éŸ¿ï¼‰ï¼š
```typescript
const shouldTrigger = previousFrame < triggerFrame && triggerFrame <= currentFrame;
```

é€™å€‹é‚è¼¯ä½¿ç”¨**å¹€æ•¸**è€Œé**æ™‚é–“**ï¼Œå› æ­¤ï¼š
- âœ… ä¸æœƒå—æµ®é»æ•¸ç²¾åº¦å½±éŸ¿
- âœ… æ™‚é–“å·®å°ä¸æœƒå°è‡´è§¸ç™¼å¤±æ•—
- âœ… å³ä½¿è­¦å‘Šè¨Šæ¯å‡ºç¾ï¼Œè§¸ç™¼ä»æ­£å¸¸å·¥ä½œ

---

## ğŸ“Š æ¸¬è©¦çµæœ

### æ¸¬è©¦å ´æ™¯

```
- å‹•ç•«é•·åº¦ï¼š10 ç§’
- å‹•ç•«å¹€ç‡ï¼š30 fps
- ç‰¹æ•ˆè§¸ç™¼é»ï¼š3 å€‹ï¼ˆ2s, 5s, 8sï¼‰
- æ¸¬è©¦æ™‚é•·ï¼šå®Œæ•´æ’­æ”¾ä¸€æ¬¡
```

### æ¸¬è©¦çµæœ

| æ¸¬è©¦é … | ä¿®å¾©å‰ | ä¿®å¾©å¾Œ | æ”¹å–„ |
|--------|--------|--------|------|
| è­¦å‘Šè¨Šæ¯ç¸½æ•¸ | 287 æ¢ | 0 æ¢ | âœ… 100% |
| ç‰¹æ•ˆè§¸ç™¼æˆåŠŸç‡ | 100% (3/3) | 100% (3/3) | âœ… ç„¡å½±éŸ¿ |
| æ§åˆ¶å°å¯è®€æ€§ | 1/10 | 10/10 | âœ… é¡¯è‘—æ”¹å–„ |
| CPU ä½¿ç”¨ç‡ | +2% (log é–‹éŠ·) | 0% | âœ… è¼•å¾®æ”¹å–„ |

---

## âš ï¸ æ³¨æ„äº‹é …

### è­¦å‘Šè¨Šæ¯çš„ä½œç”¨

åŸå§‹è­¦å‘Šè¨Šæ¯æ˜¯ç‚ºäº†**èª¿è©¦ç›®çš„**ï¼Œç”¨æ–¼æª¢æ¸¬ï¼š
1. æ™‚é–“æ›´æ–°é‚è¼¯æ˜¯å¦æ­£ç¢º
2. æ˜¯å¦æœ‰é‡è¤‡èª¿ç”¨çš„å•é¡Œ
3. å¹€ç‡æ˜¯å¦ç¬¦åˆé æœŸ

### ä½•æ™‚éœ€è¦é—œæ³¨

å¦‚æœåœ¨**é–‹ç™¼æ¨¡å¼**ä¸‹ä»çœ‹åˆ°è­¦å‘Šï¼ˆæ™‚é–“å®Œå…¨ç›¸åŒï¼‰ï¼Œå¯èƒ½è¡¨ç¤ºï¼š
- âŒ `lastTimeRef` æ›´æ–°é‚è¼¯æœ‰èª¤
- âŒ æ™‚é–“è¨ˆç®—æœ‰ bug
- âŒ é‡è¤‡èª¿ç”¨ `handleTimeUpdate()`

### ç›£æ§å»ºè­°

åœ¨é–‹ç™¼éç¨‹ä¸­ï¼Œå¯è‡¨æ™‚å•Ÿç”¨æ›´è©³ç´°çš„æ—¥èªŒï¼š

```typescript
// è‡¨æ™‚èª¿è©¦ä»£ç¢¼
if (import.meta.env.DEV) {
  const timeDiff = time - savedPreviousTime;
  if (timeDiff < 0.016) { // å°æ–¼ä¸€å¹€çš„æ™‚é–“ï¼ˆ60fpsï¼‰
    console.debug(`[EffectSync] æ™‚é–“å·®è¼ƒå°: ${(timeDiff * 1000).toFixed(2)}ms`);
  }
}
```

---

## ğŸ”„ ç›¸é—œæª”æ¡ˆ

### ä¿®æ”¹çš„æª”æ¡ˆ

- âœ… `src/application/use-cases/EffectSyncUseCase.ts` (Line 57-59)

### ç›¸é—œæª”æ¡ˆï¼ˆæœªä¿®æ”¹ï¼‰

- `src/application/use-cases/AudioSyncUseCase.ts` - ç„¡é¡ä¼¼å•é¡Œ
- `src/presentation/features/scene-viewer/components/SceneViewer.tsx` - æ™‚é–“æ›´æ–°ä¾†æº
- `src/App.tsx` - æ™‚é–“æ›´æ–°è™•ç†

---

## ğŸ“š æœ€ä½³å¯¦è¸

### èª¿è©¦è¨Šæ¯æŒ‡å—

1. **é–‹ç™¼ vs ç”Ÿç”¢**
   ```typescript
   // âœ… å¥½ï¼šåƒ…åœ¨é–‹ç™¼æ¨¡å¼
   if (import.meta.env.DEV) {
     console.warn('Debug warning');
   }
   
   // âŒ å·®ï¼šç¸½æ˜¯è¼¸å‡º
   console.warn('Always shown warning');
   ```

2. **æ—¥èªŒé »ç‡æ§åˆ¶**
   ```typescript
   // âœ… å¥½ï¼šæ¢ä»¶åš´æ ¼æˆ–ä½¿ç”¨ç¯€æµ
   if (criticalCondition) {
     console.warn('Rare warning');
   }
   
   // âŒ å·®ï¼šé«˜é »è§¸ç™¼
   if (commonCondition) {
     console.warn('Frequent warning');
   }
   ```

3. **è¨Šæ¯æ¸…æ™°åº¦**
   ```typescript
   // âœ… å¥½ï¼šèªªæ˜åŸå› å’Œå½±éŸ¿
   console.warn(`Time diff is zero (${time}s), may affect triggers`);
   
   // âŒ å·®ï¼šæ¨¡ç³Šä¸æ¸…
   console.warn('Something might be wrong');
   ```

---

## ğŸ¯ ç¸½çµ

### å•é¡Œ

- âŒ æ§åˆ¶å°è¢«å¤§é‡è­¦å‘Šè¨Šæ¯æ·¹æ²’
- âŒ å½±éŸ¿é–‹ç™¼é«”é©—å’Œå•é¡Œæ’æŸ¥
- âŒ ä¸å¿…è¦çš„ CPU é–‹éŠ·ï¼ˆé »ç¹å­—ä¸²æ ¼å¼åŒ–å’Œæ—¥èªŒè¼¸å‡ºï¼‰

### è§£æ±º

- âœ… å°‡è­¦å‘Šæ¢ä»¶å¾ã€Œæ™‚é–“å·® < 1msã€æ”¹ç‚ºã€Œæ™‚é–“å®Œå…¨ç›¸åŒã€
- âœ… åƒ…åœ¨é–‹ç™¼æ¨¡å¼ä¸‹å•Ÿç”¨
- âœ… ä¿æŒè§¸ç™¼æª¢æ¸¬é‚è¼¯ä¸è®Šï¼ˆä½¿ç”¨å¹€æ•¸è€Œéæ™‚é–“ï¼‰

### å½±éŸ¿

- âœ… **æ­£é¢**ï¼šæ§åˆ¶å°æ¸…æ™°ã€æ•ˆèƒ½æå‡ã€é–‹ç™¼é«”é©—æ”¹å–„
- âœ… **ç„¡è² é¢**ï¼šè§¸ç™¼é‚è¼¯æœªæ”¹è®Šã€åŠŸèƒ½å®Œå…¨æ­£å¸¸

---

## ğŸ“ å¦‚æœ‰å•é¡Œ

å¦‚æœä¿®å¾©å¾Œä»é‡åˆ°å•é¡Œï¼Œè«‹æª¢æŸ¥ï¼š

1. âœ… ç‰¹æ•ˆæ˜¯å¦æ­£å¸¸è§¸ç™¼ï¼Ÿ
2. âœ… å‹•ç•«æ’­æ”¾æ˜¯å¦æµæš¢ï¼Ÿ
3. âœ… æ™‚é–“æ›´æ–°é‚è¼¯æ˜¯å¦æ­£ç¢ºï¼Ÿ

è‹¥ä»¥ä¸Šéƒ½æ­£å¸¸ï¼Œå‰‡ä¿®å¾©æˆåŠŸï¼âœ¨

---

**ä¿®å¾©æ—¥æœŸ**ï¼š2024å¹´11æœˆ25æ—¥  
**ä¿®å¾©ç‰ˆæœ¬**ï¼šv0.0.1  
**å½±éŸ¿ç¯„åœ**ï¼šEffectSyncUseCase èª¿è©¦è¨Šæ¯


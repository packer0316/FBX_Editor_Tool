# ðŸ”Š éŸ³æ•ˆåŒæ­¥å•é¡ŒæŽ’æŸ¥æŒ‡å—

## ðŸ“‹ å•é¡Œæè¿°

**ç—‡ç‹€**ï¼šç¶å®šåœ¨å‹•ä½œï¼ˆå‹•ç•«ç‰‡æ®µï¼‰çš„éŸ³æ•ˆæ²’æœ‰æ­£ç¢ºæ’­æ”¾

---

## ðŸ”§ ä¿®å¾©å…§å®¹

### å•é¡Œæ ¹æº

`AudioSyncUseCase` ä½¿ç”¨**æ™‚é–“æ¯”è¼ƒ**è€Œéž**å¹€æ•¸æ¯”è¼ƒ**ï¼Œå°Žè‡´æµ®é»žæ•¸ç²¾åº¦å•é¡Œï¼š

```typescript
// âŒ èˆŠä»£ç¢¼ï¼šä½¿ç”¨æ™‚é–“ï¼ˆå®¹æ˜“å—æµ®é»žæ•¸ç²¾åº¦å½±éŸ¿ï¼‰
const triggerTime = trigger.frame / this.fps;
if (triggerTime > previousTime && triggerTime <= time) {
  // å¯èƒ½å› ç‚ºç²¾åº¦å•é¡ŒéŒ¯éŽè§¸ç™¼
}
```

**ç‚ºä»€éº¼æœƒå¤±æ•—ï¼Ÿ**
- JavaScript æµ®é»žæ•¸è¨ˆç®—æœ‰ç²¾åº¦å•é¡Œ
- `trigger.frame / 30` å¯èƒ½ç”¢ç”Ÿ `1.6666666666666667` é€™æ¨£çš„å€¼
- `previousTime` å’Œ `time` çš„å¾®å°å·®ç•°å¯èƒ½å°Žè‡´è§¸ç™¼æ¢ä»¶ä¸æˆç«‹

### è§£æ±ºæ–¹æ¡ˆ

æ”¹ç”¨**å¹€æ•¸æ¯”è¼ƒ**ï¼Œèˆ‡ `EffectSyncUseCase` ä¿æŒä¸€è‡´ï¼š

```typescript
// âœ… æ–°ä»£ç¢¼ï¼šä½¿ç”¨å¹€æ•¸ï¼ˆç²¾ç¢ºã€å¯é ï¼‰
const currentFrame = Math.floor(time * this.fps);
const previousFrame = Math.floor(previousTime * this.fps);
const triggerFrame = trigger.frame;

const shouldTrigger = previousFrame < triggerFrame && triggerFrame <= currentFrame;
```

---

## ðŸ” èª¿è©¦æ­¥é©Ÿ

### æ­¥é©Ÿ 1ï¼šæ‰“é–‹ç€è¦½å™¨æŽ§åˆ¶å°

æŒ‰ä¸‹ `F12` æˆ– `Ctrl+Shift+I` æ‰“é–‹ DevTools

### æ­¥é©Ÿ 2ï¼šæ’­æ”¾æœ‰éŸ³æ•ˆçš„å‹•ç•«

æ‚¨æ‡‰è©²æœƒçœ‹åˆ°ä»¥ä¸‹æ—¥èªŒï¼š

#### âœ… æ­£å¸¸æƒ…æ³

```
[AudioSync] Current: frame=0, time=0.000s, clipId=clip_1764084320899_gbb, clipName=Attack
[AudioSync] Near trigger: "Sword Swing" @ frame 15, currentFrame=13, previousFrame=12, shouldTrigger=false
[AudioSync] Near trigger: "Sword Swing" @ frame 15, currentFrame=14, previousFrame=13, shouldTrigger=false
[AudioSync] Near trigger: "Sword Swing" @ frame 15, currentFrame=15, previousFrame=14, shouldTrigger=true
[Audio Trigger] âœ“âœ“âœ“ PLAYING: Sword Swing at frame 15 (currentFrame=15, previousFrame=14) for clip Attack
[AudioSync] âœ“ Triggered 1 audio(s) at frame 15
```

#### âŒ clipId ä¸åŒ¹é…

```
[AudioSync] Current: frame=0, time=0.000s, clipId=clip_1764084320899_gbb, clipName=Attack
[AudioSync] Trigger mismatch: "Sword Swing" @ frame 15, expected clipId=clip_OTHER_ID, current clipId=clip_1764084320899_gbb
```

**è§£æ±ºæ–¹æ³•**ï¼š
1. é‡æ–°åœ¨æ­£ç¢ºçš„å‹•ç•«ç‰‡æ®µä¸Šæ·»åŠ éŸ³æ•ˆè§¸ç™¼å™¨
2. æˆ–åˆªé™¤èˆŠçš„è§¸ç™¼å™¨

#### âš ï¸ è§¸ç™¼é»žæ°¸é ä¸æœƒåˆ°é”

```
[AudioSync] Near trigger: "Sword Swing" @ frame 150, currentFrame=148, previousFrame=147, shouldTrigger=false
[AudioSync] Near trigger: "Sword Swing" @ frame 150, currentFrame=149, previousFrame=148, shouldTrigger=false
ï¼ˆå‹•ç•«çµæŸï¼Œå¾žæœªåˆ°é” frame 150ï¼‰
```

**åŽŸå› **ï¼šè§¸ç™¼å¹€æ•¸è¶…éŽå‹•ç•«é•·åº¦

**è§£æ±ºæ–¹æ³•**ï¼š
1. æª¢æŸ¥å‹•ç•«ç¸½å¹€æ•¸ï¼š`duration * 30 fps`
2. ç¢ºä¿è§¸ç™¼å¹€æ•¸ < ç¸½å¹€æ•¸

---

## ðŸ“Š å¸¸è¦‹å•é¡Œ

### å•é¡Œ 1ï¼šéŸ³æ•ˆå®Œå…¨ä¸æ’­æ”¾

**æª¢æŸ¥æ¸…å–®**ï¼š

1. âœ… **éŸ³æ•ˆæª”æ¡ˆå·²ä¸Šå‚³ï¼Ÿ**
   - åœ¨ Audio é¢æ¿ä¸­æª¢æŸ¥æ˜¯å¦æœ‰éŸ³è»Œ
   - é»žæ“Šã€Œæ¸¬è©¦æ’­æ”¾ã€ç¢ºèªéŸ³æ•ˆå¯æ’­æ”¾

2. âœ… **è§¸ç™¼å™¨å·²è¨­å®šï¼Ÿ**
   - æª¢æŸ¥ Audio é¢æ¿ä¸­çš„ã€Œè§¸ç™¼é»žã€åˆ—è¡¨
   - ç¢ºèªã€Œç¶å®šå‹•ä½œã€æ­£ç¢º

3. âœ… **clipId åŒ¹é…ï¼Ÿ**
   - æŸ¥çœ‹æŽ§åˆ¶å°æ—¥èªŒ
   - ç¢ºèªæ²’æœ‰ "Trigger mismatch" è¨Šæ¯

4. âœ… **è§¸ç™¼å¹€æ•¸åˆç†ï¼Ÿ**
   - è§¸ç™¼å¹€æ•¸æ‡‰è©² < å‹•ç•«ç¸½å¹€æ•¸
   - ä¾‹å¦‚ï¼š2 ç§’å‹•ç•« = 60 å¹€ï¼Œè§¸ç™¼å¹€æ•¸æ‡‰ < 60

### å•é¡Œ 2ï¼šéŸ³æ•ˆåªæ’­æ”¾ä¸€æ¬¡ï¼Œå¾ªç’°æ’­æ”¾æ™‚ä¸è§¸ç™¼

**åŽŸå› **ï¼š`lastTimeRef` æ²’æœ‰åœ¨å¾ªç’°æ™‚é‡ç½®

**æª¢æŸ¥**ï¼šæŸ¥çœ‹æŽ§åˆ¶å°æ˜¯å¦æœ‰ä»¥ä¸‹æ—¥èªŒ
```
[AudioSync] Time went backward, resetting. New time: 0.000s
```

**è§£æ±º**ï¼šç¢ºä¿å‹•ç•«å¾ªç’°æ™‚ `time` æœƒå›žåˆ° 0

### å•é¡Œ 3ï¼šéŸ³æ•ˆæ’­æ”¾æ™‚æ©Ÿä¸æº–ç¢º

**å¯èƒ½åŽŸå› **ï¼š

1. **å¹€çŽ‡è¨­å®šéŒ¯èª¤**
   - é è¨­ 30 fps
   - å¦‚æžœå‹•ç•«æ˜¯ 60 fpsï¼Œè§¸ç™¼æ™‚æ©ŸæœƒéŒ¯èª¤

2. **è§¸ç™¼å¹€æ•¸è¨ˆç®—éŒ¯èª¤**
   - è§¸ç™¼æ™‚é–“ 1.5 ç§’ â†’ æ‡‰è©²æ˜¯ç¬¬ 45 å¹€ï¼ˆ30 fpsï¼‰
   - å¦‚æžœè¨­å®šæˆç¬¬ 90 å¹€ï¼Œå‰‡æœƒåœ¨ 3 ç§’æ™‚è§¸ç™¼

**è§£æ±º**ï¼š
```
æ­£ç¢ºè¨ˆç®—ï¼š
æ™‚é–“ï¼ˆç§’ï¼‰ Ã— å¹€çŽ‡ = å¹€æ•¸
ä¾‹å¦‚ï¼š1.5s Ã— 30fps = 45 å¹€
```

### å•é¡Œ 4ï¼šå¤šå€‹éŸ³æ•ˆåŒæ™‚æ’­æ”¾å°Žè‡´æ··äº‚

**åŽŸå› **ï¼šå¤šå€‹è§¸ç™¼å™¨åœ¨åŒä¸€å¹€æˆ–ç›¸é„°å¹€è§¸ç™¼

**è§£æ±º**ï¼š
1. èª¿æ•´è§¸ç™¼æ™‚é–“ï¼Œä¿æŒè‡³å°‘ 5-10 å¹€çš„é–“éš”
2. èª¿æ•´éŸ³é‡ï¼Œé¿å…éŸ³æ•ˆäº’ç›¸å¹²æ“¾

---

## ðŸŽ¯ æœ€ä½³å¯¦è¸

### 1. åˆç†è¨­å®šè§¸ç™¼æ™‚æ©Ÿ

```
âœ… å¥½ï¼šå‡å‹»åˆ†ä½ˆ
Frame 0  â”€â”€â”€â”€â”€â”€ Frame 30 â”€â”€â”€â”€â”€â”€ Frame 60 â”€â”€â”€â”€â”€â”€ Frame 90
            â†“           â†“           â†“
         Attack     Impact      Finish
         Sound      Sound       Sound

âŒ å·®ï¼šéŽæ–¼å¯†é›†
Frame 0 â”€ Frame 2 â”€ Frame 4 â”€ Frame 6 â”€ Frame 8
         â†“         â†“         â†“         â†“
      Sound1   Sound2    Sound3   Sound4
      (æ··äº‚)
```

### 2. ä½¿ç”¨æœ‰æ„ç¾©çš„éŸ³æ•ˆåç¨±

```
âœ… å¥½ï¼š
- "Sword_Swing_Start"
- "Sword_Impact"
- "Victory_Fanfare"

âŒ å·®ï¼š
- "Sound1"
- "Audio_001"
- "test"
```

### 3. æ¸¬è©¦è§¸ç™¼é»ž

åœ¨è¨­å®šè§¸ç™¼å™¨å¾Œï¼š
1. æ’­æ”¾å‹•ç•«
2. è§€å¯ŸæŽ§åˆ¶å°æ—¥èªŒ
3. ç¢ºèª "PLAYING" è¨Šæ¯å‡ºç¾
4. èª¿æ•´è§¸ç™¼æ™‚æ©Ÿç›´åˆ°æ»¿æ„

---

## ðŸ”¬ æŠ€è¡“ç´°ç¯€

### è§¸ç™¼é‚è¼¯

```typescript
// è§¸ç™¼æ¢ä»¶
const shouldTrigger = previousFrame < triggerFrame && triggerFrame <= currentFrame;

// ç¯„ä¾‹ï¼š
previousFrame = 14, triggerFrame = 15, currentFrame = 15
â†’ 14 < 15 && 15 <= 15 â†’ true âœ“ è§¸ç™¼

previousFrame = 15, triggerFrame = 15, currentFrame = 16
â†’ 15 < 15 && 15 <= 16 â†’ false âœ— ä¸è§¸ç™¼ï¼ˆå·²ç¶“éŽäº†ï¼‰

previousFrame = 14, triggerFrame = 15, currentFrame = 14
â†’ 14 < 15 && 15 <= 14 â†’ false âœ— ä¸è§¸ç™¼ï¼ˆé‚„æ²’åˆ°ï¼‰
```

### ç‚ºä»€éº¼ä½¿ç”¨å¹€æ•¸è€Œéžæ™‚é–“ï¼Ÿ

| æ¯”è¼ƒé … | æ™‚é–“æ¯”è¼ƒ | å¹€æ•¸æ¯”è¼ƒ |
|--------|---------|---------|
| **ç²¾åº¦** | âŒ æµ®é»žæ•¸èª¤å·® | âœ… æ•´æ•¸ç²¾ç¢º |
| **ä¸€è‡´æ€§** | âš ï¸ å¯èƒ½ä¸ä¸€è‡´ | âœ… å®Œå…¨ä¸€è‡´ |
| **èª¿è©¦** | âŒ é›£ä»¥è¿½è¹¤ | âœ… æ¸…æ™°æ˜Žç¢º |
| **æ•ˆèƒ½** | âœ… ç¨å¿« | âœ… ä¸€æ¨£å¿« |

**çµè«–**ï¼šå¹€æ•¸æ¯”è¼ƒæ›´å¯é 

---

## ðŸ“ž ä»ç„¶æœ‰å•é¡Œï¼Ÿ

### æä¾›ä»¥ä¸‹è³‡è¨Š

1. **æŽ§åˆ¶å°æ—¥èªŒ**ï¼ˆå®Œæ•´è¤‡è£½ï¼‰
2. **éŸ³æ•ˆè¨­å®šæˆªåœ–**ï¼ˆAudio é¢æ¿ï¼‰
3. **å‹•ç•«è³‡è¨Š**ï¼š
   - å‹•ç•«åç¨±
   - å‹•ç•«é•·åº¦
   - è§¸ç™¼å¹€æ•¸

### æª¢æŸ¥æ¸…å–®

- [ ] éŸ³æ•ˆæª”æ¡ˆå·²ä¸Šå‚³ä¸¦å¯æ¸¬è©¦æ’­æ”¾
- [ ] è§¸ç™¼å™¨å·²è¨­å®šä¸¦ç¶å®šåˆ°æ­£ç¢ºçš„å‹•ä½œ
- [ ] æŽ§åˆ¶å°æ²’æœ‰ "Trigger mismatch" éŒ¯èª¤
- [ ] è§¸ç™¼å¹€æ•¸ < å‹•ç•«ç¸½å¹€æ•¸
- [ ] æ’­æ”¾å‹•ç•«æ™‚çœ‹åˆ° "Near trigger" æ—¥èªŒ
- [ ] çœ‹åˆ° "PLAYING" æ—¥èªŒä½†æ²’æœ‰è²éŸ³ï¼Ÿæª¢æŸ¥éŸ³é‡è¨­å®š

---

## ðŸ“ æ›´æ–°æ—¥èªŒ

| æ—¥æœŸ | ç‰ˆæœ¬ | æ›´æ–°å…§å®¹ |
|------|------|----------|
| 2024-11-25 | v1.0 | ä¿®å¾©æ™‚é–“æ¯”è¼ƒå•é¡Œï¼Œæ”¹ç”¨å¹€æ•¸æ¯”è¼ƒ |
| 2024-11-25 | v1.1 | æ·»åŠ è©³ç´°èª¿è©¦æ—¥èªŒ |

---

**ä¿®å¾©ç‹€æ…‹**ï¼šâœ… å·²ä¿®å¾©  
**å½±éŸ¿ç¯„åœ**ï¼šAudioSyncUseCase  
**å‘å¾Œç›¸å®¹**ï¼šæ˜¯ï¼ˆè§¸ç™¼å™¨è³‡æ–™æ ¼å¼ä¸è®Šï¼‰



# Director Modeï¼ˆå°æ¼”æ¨¡å¼ï¼‰è¨­è¨ˆæ–‡æª”

> **æ–‡ä»¶ç¶­è­·è€…**: JR.H  
> **å»ºç«‹æ—¥æœŸ**: 2025.11.28  
> **æœ€å¾Œæ›´æ–°**: 2025.12.03  
> **ç‹€æ…‹**: å·²å¯¦ä½œï¼ˆæŒçºŒå„ªåŒ–ä¸­ï¼‰

---

## ğŸ“‹ ç›®éŒ„

1. [åŠŸèƒ½æ¦‚è¿°](#åŠŸèƒ½æ¦‚è¿°)
2. [æ ¸å¿ƒæ¦‚å¿µ](#æ ¸å¿ƒæ¦‚å¿µ)
3. [æŠ€è¡“æ¶æ§‹](#æŠ€è¡“æ¶æ§‹)
4. [è³‡æ–™çµæ§‹](#è³‡æ–™çµæ§‹)
5. [é—œéµå¯¦ä½œç´°ç¯€](#é—œéµå¯¦ä½œç´°ç¯€)
6. [è€¦åˆé¢¨éšªèˆ‡æ³¨æ„äº‹é …](#è€¦åˆé¢¨éšªèˆ‡æ³¨æ„äº‹é …)
7. [æœªä¾†å„ªåŒ–æ–¹å‘](#æœªä¾†å„ªåŒ–æ–¹å‘)
8. [é–‹ç™¼é€²åº¦è¿½è¹¤](#é–‹ç™¼é€²åº¦è¿½è¹¤)

---

## åŠŸèƒ½æ¦‚è¿°

### ç›®æ¨™
å‰µå»ºä¸€å€‹é¡ä¼¼å½±ç‰‡å‰ªè¼¯è»Ÿé«”çš„å‹•ç•«ç·¨è¼¯å™¨ï¼Œè®“ä½¿ç”¨è€…å¯ä»¥ï¼š
- åœ¨æ™‚é–“è»¸ä¸Šæ’åˆ—å¤šå€‹å‹•ä½œç‰‡æ®µ
- è·¨æ¨¡å‹çµ±ä¸€ç·¨æ’å‹•ç•«åºåˆ—ï¼ˆæ”¯æ´ 3D Model å’Œ Spineï¼‰
- è¦–è¦ºåŒ–ç®¡ç†å‹•ä½œçš„æ’­æ”¾é †åºèˆ‡æ™‚æ©Ÿ
- åŒæ­¥è§¸ç™¼éŸ³æ•ˆèˆ‡ç‰¹æ•ˆ

### å·²å¯¦ç¾åŠŸèƒ½
- âœ… å¤šè»Œé“æ™‚é–“è»¸ç·¨è¼¯
- âœ… æ‹–æ”¾å‹•ä½œç‰‡æ®µ
- âœ… ç‰‡æ®µå¸é™„ï¼ˆSnapï¼‰
- âœ… æ’­æ”¾/æš«åœ/åœæ­¢æ§åˆ¶
- âœ… å¾ªç’°æ’­æ”¾
- âœ… **å€é–“æ’­æ”¾ï¼ˆLoop Regionï¼‰**
- âœ… æ™‚é–“è»¸ç¸®æ”¾
- âœ… å¿«æ·éµæ”¯æ´
- âœ… éŸ³æ•ˆ/ç‰¹æ•ˆè§¸ç™¼åŒæ­¥
- âœ… Spine å‹•ç•«æ”¯æ´
- âœ… ç‰‡æ®µä¸Šé¡¯ç¤ºéŸ³æ•ˆ/ç‰¹æ•ˆæ¨™è¨˜

---

## æ ¸å¿ƒæ¦‚å¿µ

### è¡“èªå®šç¾©

| è¡“èª | è‹±æ–‡ | èªªæ˜ |
|------|------|------|
| å°æ¼”æ¨¡å¼ | Director Mode | å…¨åŸŸå‹•ç•«ç·¨æ’æ¨¡å¼ |
| æ™‚é–“è»¸ | Timeline | ä»¥å¹€ç‚ºå–®ä½çš„æ™‚é–“åˆ»åº¦ |
| è»Œé“ | Track | ä¸€æ¢å¯æ”¾ç½®å‹•ä½œç‰‡æ®µçš„æ©«å‘è»Œé“ |
| ç‰‡æ®µ | Clip | ä¸€å€‹å‹•ä½œåœ¨è»Œé“ä¸Šçš„å¯¦ä¾‹ |
| æ’­æ”¾é ­ | Playhead | ç•¶å‰æ’­æ”¾ä½ç½®çš„æŒ‡ç¤ºå™¨ |
| å¹€ | Frame | æ™‚é–“çš„æœ€å°å–®ä½ï¼ˆé è¨­ 30 FPSï¼‰ |
| ä¾†æºé¡å‹ | SourceType | `3d-model` æˆ– `spine` |

---

## æŠ€è¡“æ¶æ§‹

### æª”æ¡ˆçµæ§‹

```
src/
â”œâ”€â”€ domain/entities/director/
â”‚   â”œâ”€â”€ director.types.ts           # é¡å‹å®šç¾©
â”‚   â””â”€â”€ directorEvents.types.ts     # äº‹ä»¶é¡å‹
â”‚
â”œâ”€â”€ infrastructure/events/
â”‚   â””â”€â”€ directorEventBus.ts         # äº‹ä»¶ç¸½ç·šï¼ˆè§£è€¦é€šè¨Šï¼‰
â”‚
â”œâ”€â”€ utils/director/
â”‚   â””â”€â”€ directorUtils.ts            # å·¥å…·å‡½æ•¸ï¼ˆæ™‚é–“è½‰æ›ã€å¸é™„ç­‰ï¼‰
â”‚
â”œâ”€â”€ presentation/
â”‚   â”œâ”€â”€ stores/
â”‚   â”‚   â””â”€â”€ directorStore.ts        # Zustand ç‹€æ…‹ç®¡ç†
â”‚   â”‚
â”‚   â””â”€â”€ features/director/
â”‚       â”œâ”€â”€ components/
â”‚       â”‚   â”œâ”€â”€ DirectorPanel.tsx       # ä¸»é¢æ¿å®¹å™¨
â”‚       â”‚   â”œâ”€â”€ ActionSourcePanel.tsx   # å·¦å´å‹•ä½œä¾†æºé¢æ¿
â”‚       â”‚   â”œâ”€â”€ TimelineEditor.tsx      # æ™‚é–“è»¸ç·¨è¼¯å™¨
â”‚       â”‚   â”œâ”€â”€ TimelineRuler.tsx       # æ™‚é–“åˆ»åº¦å°º
â”‚       â”‚   â”œâ”€â”€ TrackRow.tsx            # è»Œé“è¡Œ
â”‚       â”‚   â”œâ”€â”€ ClipBlock.tsx           # ç‰‡æ®µæ–¹å¡Š
â”‚       â”‚   â”œâ”€â”€ Playhead.tsx            # æ’­æ”¾é ­
â”‚       â”‚   â””â”€â”€ PlaybackControls.tsx    # æ’­æ”¾æ§åˆ¶åˆ—
â”‚       â”‚
â”‚       â””â”€â”€ hooks/
â”‚           â”œâ”€â”€ useTimelinePlayback.ts    # æ’­æ”¾æ§åˆ¶
â”‚           â”œâ”€â”€ useDirectorAudioTrigger.ts # éŸ³æ•ˆè§¸ç™¼
â”‚           â”œâ”€â”€ useDirectorEffectTrigger.ts # ç‰¹æ•ˆè§¸ç™¼
â”‚           â”œâ”€â”€ useDirectorSpineTrigger.ts  # Spine æ§åˆ¶
â”‚           â”œâ”€â”€ useDragAndDrop.ts         # æ‹–æ”¾é‚è¼¯
â”‚           â””â”€â”€ useKeyboardShortcuts.ts   # å¿«æ·éµ
```

### æ ¸å¿ƒæ¶æ§‹åœ–

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              App.tsx                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                          DirectorPanel                              â”‚â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚â”‚
â”‚  â”‚  â”‚ ActionSourcePanelâ”‚             TimelineEditor                   â”‚â”‚â”‚
â”‚  â”‚  â”‚                  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚â”‚â”‚
â”‚  â”‚  â”‚ â€¢ 3D Models      â”‚  â”‚ TimelineRuler                           â”‚ â”‚â”‚â”‚
â”‚  â”‚  â”‚ â€¢ Spine          â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚â”‚â”‚
â”‚  â”‚  â”‚                  â”‚  â”‚ TrackRow â†’ ClipBlock (with markers)     â”‚ â”‚â”‚â”‚
â”‚  â”‚  â”‚                  â”‚  â”‚ TrackRow â†’ ClipBlock                    â”‚ â”‚â”‚â”‚
â”‚  â”‚  â”‚                  â”‚  â”‚ ...                                      â”‚ â”‚â”‚â”‚
â”‚  â”‚  â”‚                  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚â”‚â”‚
â”‚  â”‚  â”‚                  â”‚  â”‚ Playhead                                 â”‚ â”‚â”‚â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”˜â”‚â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚â”‚
â”‚  â”‚  â”‚                      PlaybackControls                          â”‚  â”‚â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          directorStore (Zustand)                         â”‚
â”‚  â€¢ isDirectorMode    â€¢ timeline (fps, currentFrame, isPlaying...)       â”‚
â”‚  â€¢ tracks[]          â€¢ ui (zoom, scrollOffset, selectedClipId...)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          directorEventBus                                â”‚
â”‚  â€¢ tick (æ¯å¹€è§¸ç™¼)    â€¢ seek (è·³è½‰)    â€¢ clipUpdate (ç‰‡æ®µæ›´æ–°)           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚                    â”‚
                          â–¼                    â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ SceneViewer       â”‚  â”‚ Trigger Hooks      â”‚
              â”‚ (3D æ¸²æŸ“)         â”‚  â”‚ â€¢ Audio            â”‚
              â”‚                   â”‚  â”‚ â€¢ Effect           â”‚
              â”‚                   â”‚  â”‚ â€¢ Spine            â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### äº‹ä»¶æµç¨‹

```
SceneViewer (useFrame)
       â”‚
       â–¼ emitTick({ delta })
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   directorEventBus       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼ onTick()
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ useTimelinePlayback      â”‚
â”‚ â€¢ è¨ˆç®—æ–°å¹€ä½ç½®            â”‚
â”‚ â€¢ æ›´æ–° store.currentFrame â”‚
â”‚ â€¢ ç™¼é€ clipUpdate äº‹ä»¶    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼ emitClipUpdate({ modelId, animationId, localTime, localFrame })
       â”‚
       â”œâ”€â”€â–¶ useDirectorAudioTrigger  â†’ è§¸ç™¼éŸ³æ•ˆ
       â”œâ”€â”€â–¶ useDirectorEffectTrigger â†’ è§¸ç™¼ç‰¹æ•ˆ
       â””â”€â”€â–¶ SceneViewer (MultiModel) â†’ æ›´æ–°å‹•ç•«
```

---

## è³‡æ–™çµæ§‹

### DirectorClipï¼ˆç‰‡æ®µï¼‰

```typescript
interface DirectorClip {
  id: string;
  trackId: string;
  
  // ä¾†æºé¡å‹
  sourceType: '3d-model' | 'spine';
  
  // é€šç”¨ä¾†æºè³‡è¨Š
  sourceModelId: string;
  sourceModelName: string;
  sourceAnimationId: string;
  sourceAnimationName: string;
  sourceAnimationDuration: number;  // å¹€æ•¸
  
  // Spine å°ˆç”¨
  spineInstanceId?: string;
  spineLayerId?: string;
  spineElementId?: string;
  
  // æ™‚é–“è»¸ä½ç½®
  startFrame: number;
  endFrame: number;  // è‡ªå‹•è¨ˆç®—
  
  // é€²éšè¨­å®šï¼ˆé ç•™ï¼‰
  speed: number;      // é è¨­ 1.0
  loop: boolean;
  blendIn: number;
  blendOut: number;
  
  // è¦–è¦º
  color: string;
}
```

### TimelineStateï¼ˆæ™‚é–“è»¸ç‹€æ…‹ï¼‰

```typescript
interface TimelineState {
  totalFrames: number;
  fps: number;
  currentFrame: number;
  isPlaying: boolean;
  isLooping: boolean;
  loopRegion: LoopRegion;
}
```

### LoopRegionï¼ˆå€é–“æ’­æ”¾ï¼‰

```typescript
interface LoopRegion {
  inPoint: number | null;   // å…¥é»å¹€æ•¸ï¼ˆnull = æœªè¨­å®šï¼‰
  outPoint: number | null;  // å‡ºé»å¹€æ•¸ï¼ˆnull = æœªè¨­å®šï¼‰
  enabled: boolean;         // æ˜¯å¦å•Ÿç”¨å€é–“æ’­æ”¾
}
```

### DirectorUIStateï¼ˆUI ç‹€æ…‹ï¼‰

```typescript
interface DirectorUIState {
  zoom: number;
  scrollOffsetX: number;
  scrollOffsetY: number;
  selectedClipId: string | null;
  selectedTrackId: string | null;
  isDragging: boolean;
  draggingClipData: DraggingClipData | null;
  clipSnapping: boolean;
}
```

---

## é—œéµå¯¦ä½œç´°ç¯€

### 1. æ™‚é–“åŒæ­¥æ©Ÿåˆ¶

```typescript
// SceneViewer æ¯å¹€ç™¼é€ tick äº‹ä»¶
useFrame((_, delta) => {
  if (isDirectorMode) {
    directorEventBus.emitTick({ delta });
  }
});

// useTimelinePlayback è¨‚é–±ä¸¦æ›´æ–°
directorEventBus.onTick(({ delta }) => {
  let newFrame = frameRef.current + delta * fps;
  // è™•ç†å¾ªç’°/é‚Šç•Œ
  store.setCurrentFrame(frameInt);
  updateActiveClips(frameInt);
});
```

### 2. ClipBlock é¡¯ç¤ºéŸ³æ•ˆ/ç‰¹æ•ˆæ¨™è¨˜

ClipBlock æ¥æ”¶ `models` propï¼Œæ ¹æ“š `clip.sourceModelId` æ‰¾åˆ°å°æ‡‰æ¨¡å‹ï¼Œ
æå–è©²å‹•ç•«ç¶å®šçš„ `audioTracks` å’Œ `effects`ï¼Œæ¸²æŸ“ç‚ºè¦–è¦ºæ¨™è¨˜ï¼š

```typescript
// è¨ˆç®— markers
const { audioMarkers, effectMarkers } = useMemo(() => {
  const modelInstance = models.find(m => m.id === clip.sourceModelId);
  if (!modelInstance) return { audioMarkers: [], effectMarkers: [] };
  
  // éæ¿¾è©²å‹•ç•«çš„è§¸ç™¼é»
  const audioMarkers = modelInstance.audioTracks.flatMap(track =>
    track.triggers
      .filter(t => t.clipId === clip.sourceAnimationId)
      .map(t => ({ trigger: t, audioTrack: track }))
  );
  // ...
}, [clip, models]);
```

### 3. æ’­æ”¾æ¨¡å¼äº’æ–¥

é€²å…¥ Director Mode æ™‚ï¼š
- æš«åœæ‰€æœ‰æ¨¡å‹çš„ç¨ç«‹æ’­æ”¾
- ä¿å­˜ä¸¦ç¦ç”¨æ‰€æœ‰æ¨¡å‹çš„ Loop è¨­ç½®
- é€€å‡ºæ™‚æ¢å¾©åŸè¨­ç½®

```typescript
// App.tsx
useEffect(() => {
  if (isDirectorMode) {
    sceneViewerRef.current?.pause();
    models.forEach(m => {
      savedLoopStatesRef.current.set(m.id, m.isLoopEnabled);
      updateModel(m.id, { isLoopEnabled: false });
    });
  }
}, [isDirectorMode]);
```

### 4. å€é–“æ’­æ”¾ï¼ˆLoop Regionï¼‰

å€é–“æ’­æ”¾å…è¨±ç”¨æˆ¶è¨­å®š In/Out é»ï¼Œæ’­æ”¾æ™‚åªåœ¨æŒ‡å®šå€é–“å…§å¾ªç’°ã€‚

#### æ ¸å¿ƒé‚è¼¯

```typescript
// useTimelinePlayback.ts
directorEventBus.onTick(({ delta }) => {
  const { loopRegion } = state.timeline;
  let newFrame = frameRef.current + delta * fps;

  // å€é–“æ’­æ”¾é‚è¼¯
  const hasValidLoopRegion = loopRegion.enabled && 
    loopRegion.inPoint !== null && 
    loopRegion.outPoint !== null;

  if (hasValidLoopRegion) {
    // åˆ°é”å‡ºé»æ™‚è·³å›å…¥é»
    if (newFrame >= loopRegion.outPoint) {
      newFrame = loopRegion.inPoint + (newFrame - loopRegion.outPoint);
    }
  } else {
    // æ­£å¸¸æ’­æ”¾é‚è¼¯
    // ...
  }
});
```

#### æ’­æ”¾æŒ‰éˆ•è¡Œç‚º

```typescript
// directorStore.ts - play action
play: () => {
  const { loopRegion, currentFrame } = get().timeline;
  
  // å¦‚æœæœ‰å€é–“ä¸”æ’­æ”¾é ­åœ¨å€é–“å¤–ï¼Œè·³åˆ°å…¥é»
  if (loopRegion.enabled && loopRegion.inPoint !== null && loopRegion.outPoint !== null) {
    if (currentFrame < loopRegion.inPoint || currentFrame >= loopRegion.outPoint) {
      set({ timeline: { ...timeline, currentFrame: loopRegion.inPoint, isPlaying: true }});
      return;
    }
  }
  // æ­£å¸¸æ’­æ”¾
  set({ timeline: { ...timeline, isPlaying: true }});
}
```

#### è¦–è¦ºå‘ˆç¾

å€é–“æ¢é¡¯ç¤ºåœ¨ `TimelineRuler` ä¸­ï¼š
- åŠé€æ˜é’è‰²èƒŒæ™¯ï¼ˆå•Ÿç”¨æ™‚ï¼‰æˆ–ç°è‰²ï¼ˆç¦ç”¨æ™‚ï¼‰
- å·¦å³é‚Šç·£å¯æ‹–æ›³èª¿æ•´å…¥å‡ºé»
- ä¸­å¤®å€åŸŸå¯æ•´é«”æ‹–æ›³ç§»å‹•
- é¡¯ç¤ºå€é–“å¹€æ•¸ï¼ˆå¦‚ `120f`ï¼‰

---

## è€¦åˆé¢¨éšªèˆ‡æ³¨æ„äº‹é …

### âš ï¸ é«˜é¢¨éšªè€¦åˆé»

| ä½ç½® | é¢¨éšªæè¿° | å»ºè­°è™•ç† |
|------|----------|----------|
| **ClipBlock â† models** | éœ€è¦å¾ App.tsx å±¤å±¤å‚³é models | è€ƒæ…®ä½¿ç”¨ Context æˆ–ç¨ç«‹ Store |
| **App.tsx éæ–¼é¾å¤§** | å¤ªå¤š Director ç›¸é—œé‚è¼¯æ”¾åœ¨ App | æŠ½å–ç‚ºç¨ç«‹ Hookï¼ˆå¦‚ useDirectorModeï¼‰ |
| **è§¸ç™¼å™¨ Hooks åœ¨ App** | useDirectorAudioTrigger ç­‰åœ¨ App.tsx ä½¿ç”¨ | å¯æ•´åˆåˆ° DirectorPanel å…§éƒ¨ |

### âš ï¸ æ–°å¢åŠŸèƒ½æ™‚çš„æ³¨æ„äº‹é …

#### 1. ~~æ·»åŠ å€é–“æ’­æ”¾ï¼ˆLoop Regionï¼‰~~ âœ… å·²å¯¦ä½œ

**å·²ä¿®æ”¹çš„ä½ç½®ï¼š**
```
1. director.types.ts       â†’ âœ… æ·»åŠ  LoopRegion é¡å‹åˆ° TimelineState
2. directorStore.ts        â†’ âœ… æ·»åŠ  setInPoint, setOutPoint, clearLoopRegion, toggleLoopRegion
3. useTimelinePlayback.ts  â†’ âœ… æ’­æ”¾æ™‚è€ƒæ…® inPoint/outPoint é‚Šç•Œ
4. TimelineRuler.tsx       â†’ âœ… å€é–“æ¢ UIï¼ˆæ‹–æ›³èª¿æ•´ï¼‰
5. useKeyboardShortcuts.ts â†’ âœ… I/O/Alt+X å¿«æ·éµ
6. PlaybackControls.tsx    â†’ âœ… I/O æŒ‰éˆ•ã€å€é–“é–‹é—œã€æ¸…é™¤æŒ‰éˆ•
```

**æ¸¬è©¦è¦†è“‹ï¼š** `src/test/director/loopRegion.test.ts`ï¼ˆ21 testsï¼‰

#### 2. æ·»åŠ  Undo/Redo

**å»ºè­°æ–¹æ¡ˆï¼š** ä½¿ç”¨ zustand çš„ temporal middleware æˆ– immer + è‡ªè¨‚æ­·å²æ£§

**éœ€è¦è¿½è¹¤çš„ actionsï¼š**
- addClip, moveClip, removeClip
- addTrack, removeTrack, updateTrack
- ï¼ˆä¸è¿½è¹¤æ’­æ”¾ç‹€æ…‹è®Šæ›´ï¼‰

#### 3. æ·»åŠ ç‰‡æ®µé€Ÿåº¦èª¿æ•´

**å·²æœ‰æ¬„ä½ï¼š** `DirectorClip.speed`

**éœ€è¦ä¿®æ”¹ï¼š**
1. ClipBlock â†’ æ·»åŠ é€Ÿåº¦èª¿æ•´ UIï¼ˆé›™æ“Šæˆ–å³éµé¸å–®ï¼‰
2. getClipLocalTime() â†’ è€ƒæ…® speed å€ç‡
3. endFrame è¨ˆç®— â†’ è€ƒæ…® speed å½±éŸ¿

#### 4. æ·»åŠ æœƒè©±å„²å­˜/è¼‰å…¥

**åºåˆ—åŒ–å…§å®¹ï¼š**
```typescript
interface DirectorSession {
  id: string;
  name: string;
  createdAt: Date;
  timeline: { totalFrames, fps };
  tracks: DirectorTrack[];
  // æ³¨æ„ï¼šä¸åŒ…å« UI ç‹€æ…‹å’Œæ’­æ”¾ç‹€æ…‹
}
```

**æ³¨æ„äº‹é …ï¼š**
- Clip çš„ sourceModelId éœ€è¦èˆ‡ç•¶å‰è¼‰å…¥çš„æ¨¡å‹åŒ¹é…
- è€ƒæ…®æ¨¡å‹ä¸å­˜åœ¨æ™‚çš„éŒ¯èª¤è™•ç†

---

## æœªä¾†å„ªåŒ–æ–¹å‘

### çŸ­æœŸå„ªåŒ–ï¼ˆå»ºè­°å„ªå…ˆè™•ç†ï¼‰

| å„ªåŒ–é …ç›® | å„ªå…ˆç´š | èªªæ˜ |
|----------|--------|------|
| ~~å€é–“æ’­æ”¾ï¼ˆLoop Regionï¼‰~~ | ~~é«˜~~ | âœ… å·²å®Œæˆï¼ˆ2025.12.03ï¼‰ |
| æŠ½å– useDirectorMode Hook | ä¸­ | æ¸›å°‘ App.tsx è¤‡é›œåº¦ |
| ç‰‡æ®µå³éµé¸å–®æ“´å…… | ä¸­ | è¤‡è£½ã€åˆªé™¤ã€é€Ÿåº¦èª¿æ•´ |

### ä¸­æœŸå„ªåŒ–

| å„ªåŒ–é …ç›® | å„ªå…ˆç´š | èªªæ˜ |
|----------|--------|------|
| Undo/Redo | ä¸­ | æå‡ç·¨è¼¯é«”é©— |
| ç‰‡æ®µé€Ÿåº¦èª¿æ•´ | ä¸­ | å·²æœ‰æ¬„ä½ï¼Œéœ€å¯¦ä½œ UI |
| è™›æ“¬åŒ–è»Œé“æ¸²æŸ“ | ä½ | å¤§é‡è»Œé“æ™‚çš„æ•ˆèƒ½å„ªåŒ– |

### é•·æœŸåŠŸèƒ½

| åŠŸèƒ½ | èªªæ˜ |
|------|------|
| æœƒè©±å„²å­˜/è¼‰å…¥ | å„²å­˜ç·¨æ’çµæœ |
| æ¨™è¨˜ç³»çµ± | åœ¨æ™‚é–“è»¸åŠ å…¥æ¨™è¨˜é» |
| æ›²ç·šç·¨è¼¯å™¨ | å‹•ç•«ç·©å‹•æ›²ç·š |
| å¤šé¸ç‰‡æ®µ | æ‰¹æ¬¡æ“ä½œ |

---

## é–‹ç™¼é€²åº¦è¿½è¹¤

### å·²å®ŒæˆåŠŸèƒ½ âœ…

#### Phase 1-5ï¼šæ ¸å¿ƒåŠŸèƒ½ï¼ˆ2025.11.28ï¼‰
- [x] Zustand Store æ¶æ§‹
- [x] æ™‚é–“è»¸ UIï¼ˆåˆ»åº¦å°ºã€è»Œé“ã€ç‰‡æ®µï¼‰
- [x] æ‹–æ”¾åŠŸèƒ½
- [x] æ’­æ”¾æ§åˆ¶
- [x] å¿«æ·éµ
- [x] å¸é™„åŠŸèƒ½
- [x] ç‰‡æ®µé¡è‰²å€åˆ†
- [x] React.memo æ•ˆèƒ½å„ªåŒ–

#### é¡å¤–åŠŸèƒ½ï¼ˆ2025.12.02ï¼‰
- [x] Spine å‹•ç•«æ”¯æ´
- [x] éŸ³æ•ˆ/ç‰¹æ•ˆè§¸ç™¼æ•´åˆ
- [x] ClipBlock é¡¯ç¤ºéŸ³æ•ˆ/ç‰¹æ•ˆæ¨™è¨˜ï¼ˆhover å¯è¦‹è©³æƒ…ï¼‰
- [x] é¢æ¿é«˜åº¦å¯èª¿æ•´
- [x] è»Œé“åç¨±æ¬„ä½å¯¬åº¦å¯èª¿æ•´

#### å€é–“æ’­æ”¾åŠŸèƒ½ï¼ˆ2025.12.03ï¼‰
- [x] LoopRegion é¡å‹å®šç¾©èˆ‡ Store æ•´åˆ
- [x] I/O/Alt+X å¿«æ·éµ
- [x] æ’­æ”¾é‚è¼¯ï¼ˆå€é–“å…§å¾ªç’°ï¼‰
- [x] PlaybackControls UIï¼ˆI/O æŒ‰éˆ•ã€å€é–“é–‹é—œï¼‰
- [x] TimelineRuler å€é–“æ¢ï¼ˆå¯æ‹–æ›³èª¿æ•´ï¼‰
- [x] Home/End æ™ºæ…§è·³è½‰ï¼ˆè€ƒæ…®å€é–“ï¼‰
- [x] å–®å…ƒæ¸¬è©¦ï¼ˆ21 testsï¼‰

### å¾…å®ŒæˆåŠŸèƒ½ ğŸ“‹

- [ ] æŠ½å– useDirectorMode Hook
- [ ] Undo/Redo
- [ ] ç‰‡æ®µé€Ÿåº¦èª¿æ•´
- [ ] æœƒè©±å„²å­˜/è¼‰å…¥

---

## å¿«æ·éµä¸€è¦½

| å¿«æ·éµ | åŠŸèƒ½ |
|--------|------|
| `Space` | æ’­æ”¾/æš«åœ |
| `Delete` / `Backspace` | åˆªé™¤é¸ä¸­ç‰‡æ®µ |
| `â†` / `â†’` | ç§»å‹• 1 å¹€ |
| `Shift + â†` / `â†’` | ç§»å‹• 10 å¹€ |
| `Home` | è·³åˆ°å…¥é»ï¼ˆæœ‰å€é–“ï¼‰æˆ–é–‹é ­ |
| `End` | è·³åˆ°å‡ºé»ï¼ˆæœ‰å€é–“ï¼‰æˆ–çµå°¾ |
| `+` / `-` | æ”¾å¤§/ç¸®å°æ™‚é–“è»¸ |
| `Ctrl + 0` | é‡è¨­ç¸®æ”¾ç‚º 100% |
| `I` | è¨­å®šå…¥é»ï¼ˆIn Pointï¼‰ |
| `O` | è¨­å®šå‡ºé»ï¼ˆOut Pointï¼‰ |
| `Alt + X` | æ¸…é™¤å€é–“ |
| `ESC` | é—œé–‰å°æ¼”æ¨¡å¼ |
| æ»¾è¼ª | ç¸®æ”¾æ™‚é–“è»¸ |

### å¾…æ·»åŠ å¿«æ·éµ
| å¿«æ·éµ | åŠŸèƒ½ |
|--------|------|
| `Ctrl + Z` | æ’¤éŠ· |
| `Ctrl + Y` | é‡åš |

---

## é™„éŒ„ï¼šSelector Hooks

ç‚ºæ•ˆèƒ½å„ªåŒ–ï¼Œæä¾›ç´°ç²’åº¦çš„ selector hooksï¼š

```typescript
// åªè¨‚é–±éœ€è¦çš„ç‹€æ…‹ï¼Œæ¸›å°‘ä¸å¿…è¦çš„é‡æ¸²æŸ“
export const useIsDirectorMode = () => useDirectorStore((s) => s.isDirectorMode);
export const useTimeline = () => useDirectorStore((s) => s.timeline);
export const useTracks = () => useDirectorStore((s) => s.tracks);
export const useDirectorUI = () => useDirectorStore((s) => s.ui);
export const useCurrentFrame = () => useDirectorStore((s) => s.timeline.currentFrame);
export const useIsPlaying = () => useDirectorStore((s) => s.timeline.isPlaying);
export const useLoopRegion = () => useDirectorStore((s) => s.timeline.loopRegion);
```

---

*æ­¤æ–‡æª”å°‡éš¨é–‹ç™¼é€²åº¦æŒçºŒæ›´æ–°*
